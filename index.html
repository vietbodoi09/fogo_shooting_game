<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fogo Shooting Game — Sponsored</title>
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
<style>
body { background:#071029;color:#e6eef8;font-family:Inter,Arial;margin:0;padding:16px;user-select:none;overflow:hidden;display:flex;justify-content:center;align-items:flex-start;gap:64px; }
#gameContainer { position:relative;width:480px;display:flex;flex-direction:column;align-items:center; }
#game { border-radius:8px;background:linear-gradient(#02111a,#071b24);display:block;margin:0 auto; }
#scoreTimer { position:absolute;left:50%;transform:translateX(-50%);top:8px;color:#cfe8ff;font-size:18px;font-weight:bold;text-align:center;z-index:10;pointer-events:none;text-shadow:0 0 5px #000; }
#logBox { width:250px;height:300px;overflow-y:auto;background:rgba(15,30,50,0.7);border-radius:8px;padding:16px;color:#9fb6d6;font-size:13px;font-family:monospace;display:flex;flex-direction:column-reverse; }
.logEntry { padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.1); }
#controlsPanel { display:flex;flex-direction:column;gap:16px;align-items:flex-end;margin-top:16px; }
.controlsGroup { display:flex;gap:8px; }
button { padding:8px 12px;border-radius:6px;border:none;background:#3a7bd5;color:white;cursor:pointer;font-weight:600; }
button:disabled { background:#666;cursor:not-allowed; }
#gameOverOverlay { position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;flex-direction:column;justify-content:center;align-items:center;color:white;z-index:20;text-align:center;gap:16px;visibility:hidden;opacity:0;transition:visibility 0s,opacity 0.5s linear; }
#gameOverOverlay.visible { visibility:visible;opacity:1; }
#gameOverOverlay h2 { font-size:32px;margin:0; }
#xInput { padding:8px 12px;border-radius:6px;border:1px solid #666;background:#111;color:white;font-family:Inter,Arial;margin-right:8px; }
#leaderboard { width:250px;background:rgba(15,30,50,0.7);border-radius:8px;padding:16px;color:#e6eef8; }
#leaderboard h3 { margin-top:0;text-align:center; }
#leaderboard ol { padding-left:20px;margin:0; }
#leaderboard li { display:flex;justify-content:space-between;margin-bottom:8px; }
#leaderboard li:nth-child(1) { color:gold;font-weight:bold; }
#leaderboard li:nth-child(2) { color:silver;font-weight:bold; }
#leaderboard li:nth-child(3) { color:#cd7f32;font-weight:bold; }
</style>
</head>
<body>
<div style="display:flex;gap:64px;align-items:flex-start;">
    <aside id="leaderboard">
        <h3>Leaderboard</h3>
        <ol id="leaderboardList"></ol>
    </aside>
    <div id="gameContainer">
        <canvas id="game" width="480" height="640"></canvas>
        <div id="gameOverOverlay">
            <h2>Game Over!</h2>
            <button id="resetBtn">Reset Game</button>
        </div>
        <div id="scoreTimer">Score: 0 | Time: 60</div>
    </div>
    <div>
        <div id="controlsPanel">
            <input id="xInput" type="text" placeholder="Your X handle" />
            <button id="connectBtn">Connect Wallet</button>
        </div>
        <div id="logBox"></div>
    </div>
</div>
<script>
(async ()=>{
    const PAYMASTER_URL='https://fogoshooting.shop:3000'; // backend phải allow CORS với https://vietbodoi09.github.io
    const connection=new solanaWeb3.Connection('https://api.testnet.fogo.io','confirmed');
    const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d');
    const scoreTimerEl=document.getElementById('scoreTimer');
    const logBox=document.getElementById('logBox');
    const connectBtn=document.getElementById('connectBtn');
    const resetBtn=document.getElementById('resetBtn');
    const gameOverOverlay=document.getElementById('gameOverOverlay');
    const xInput=document.getElementById('xInput');
    const leaderboardList=document.getElementById('leaderboardList');

    let playerPubkey=null, xHandle=null, ship={x:canvas.width/2-25,y:canvas.height-60,width:50,height:20,speed:4}, bullets=[], enemies=[], enemyBullets=[];
    let score=0, timeLeft=60000, gameOver=true, keysPressed={}, lastShotTime=0;

    function addLog(msg){ const div=document.createElement('div'); div.className='logEntry'; div.textContent=msg; logBox.prepend(div); if(logBox.childElementCount>15) logBox.removeChild(logBox.lastChild); }
    function isColliding(a,b){ return(a.x<b.x+b.width && a.x+a.width>b.x && a.y<b.y+b.height && a.y+a.height>b.y); }

    function resetGame(){ ship={x:canvas.width/2-25,y:canvas.height-60,width:50,height:20}; bullets=[]; enemies=[]; enemyBullets=[]; score=0; timeLeft=60000; gameOver=false; gameOverOverlay.classList.remove('visible'); addLog('Game reset'); }
    function spawnEnemy(){ const size=40; const x=Math.random()*(canvas.width-size); enemies.push({x,y:-size,width:size,height:size,speed:1+Math.random(),shootTimer:0,shootInterval:1500+Math.random()*1000}); }

    function draw(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#02111a'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#4caf50'; ctx.fillRect(ship.x,ship.y,ship.width,ship.height); ctx.fillStyle='#ffde59'; bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.width,b.height)); ctx.fillStyle='#d32f2f'; enemies.forEach(e=>ctx.fillRect(e.x,e.y,e.width,e.height)); ctx.fillStyle='#ff6e6e'; enemyBullets.forEach(b=>ctx.fillRect(b.x,b.y,b.width,b.height)); }

    function update(delta){ if(gameOver) return; timeLeft-=delta; if(timeLeft<=0){ gameOver=true; gameOverOverlay.classList.add('visible'); sendTx('score',score); return; } scoreTimerEl.textContent=`Score: ${score} | Time: ${Math.ceil(timeLeft/1000)}`; if(Math.random()<delta/2000){ spawnEnemy(); } bullets.forEach((b,i)=>{ b.y-=8; if(b.y<-b.height) bullets.splice(i,1); enemies.forEach((e,j)=>{ if(isColliding(b,e)){ bullets.splice(i,1); enemies.splice(j,1); score++; } }); }); enemyBullets.forEach((b,i)=>{ b.y+=2.5; if(b.y>canvas.height+b.height) enemyBullets.splice(i,1); if(isColliding(b,ship)){ gameOver=true; gameOverOverlay.classList.add('visible'); sendTx('score',score); } }); if(keysPressed.ArrowLeft){ ship.x-=ship.speed; if(ship.x<0) ship.x=0; } if(keysPressed.ArrowRight){ ship.x+=ship.speed; if(ship.x+ship.width>canvas.width) ship.x=canvas.width-ship.width; } }

    function gameLoop(ts){ const delta=ts-(window.lastTs||ts); window.lastTs=ts; update(delta); draw(); if(!gameOver) requestAnimationFrame(gameLoop); }

    window.addEventListener('keydown',e=>{ keysPressed[e.code]=true; if(e.code==='Space'){ if(Date.now()-lastShotTime>200){ lastShotTime=Date.now(); bullets.push({x:ship.x+ship.width/2-2.5,y:ship.y-10,width:5,height:10}); sendTx('shoot'); } } });
    window.addEventListener('keyup',e=>{ keysPressed[e.code]=false; });

    async function sendTx(action,value=null){
        if(!playerPubkey){ addLog('Connect wallet first'); return; }
        try{
            const body={ action, player:playerPubkey.toBase58() };
            if(action==='register' && xHandle) body.xHandle=xHandle;
            if(action==='score') body.score=value;
            const resp=await fetch(PAYMASTER_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
            if(!resp.ok){ addLog('Paymaster error '+resp.status); return; }
            const data=await resp.json();
            if(data.txSignature) addLog(`Tx: ${data.txSignature}`);
        }catch(e){ addLog('Tx error: '+(e.message||e)); }
    }

    async function fetchLeaderboard(){ try{ const resp=await fetch(PAYMASTER_URL+'/leaderboard'); if(!resp.ok){ addLog('Leaderboard fetch error'); return; } const data=await resp.json(); leaderboardList.innerHTML=''; data.forEach(p=>{ const li=document.createElement('li'); li.innerHTML=`<span>${p.xHandle||p.player.slice(0,4)+'...'}</span><span>${p.score}</span>`; leaderboardList.appendChild(li); }); }catch(e){ addLog('Leaderboard error: '+(e.message||e)); } }

    connectBtn.addEventListener('click',async ()=>{
        xHandle=xInput.value.trim();
        const provider=window.solana||(window.nightly&&window.nightly.solana);
        if(!provider||!provider.connect){ addLog('Wallet not found'); return; }
        const resp=await provider.connect();
        playerPubkey=resp.publicKey||provider.publicKey;
        addLog('Connected: '+playerPubkey.toBase58());
        connectBtn.disabled=true; xInput.disabled=true;
        await sendTx('register'); fetchLeaderboard(); resetGame(); requestAnimationFrame(gameLoop);
    });

    resetBtn.addEventListener('click',()=>{ resetGame(); requestAnimationFrame(gameLoop); });

    addLog('Ready. Connect wallet, use ← → to move, Space to shoot.');
    fetchLeaderboard();
})();
</script>
</body>
</html>
